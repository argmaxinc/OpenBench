name: Diarization Benchmark
run_name: Diarization Benchmark ${{ github.event.date }} - ${{ github.sha }}

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 5 * *'  # Every month on the 5th day of the month at 5:00 AM UTC

jobs:
  diarization-benchmark:
    strategy:
      fail-fast: false
      matrix:
        dataset:
          - callhome
          - dihard-3
          - ami-ihm
          - ami-sdm
          - earnings21
          - msdwild
          - voxconverse
          - american-life-podcast
          - ava-avd
          - ego4d
          - ali-meetings
          - aishell-4

        pipeline:
          - pyannote-api
          - aws-diarization
          - deepgram-diarization
        
    uses: ./.github/workflows/run_evaluate.yaml
    env:
      DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
      PYANNOTE_TOKEN: ${{ secrets.PYANNOTE_API_TOKEN }}
    with:
      runner: M3-Ultra
      dataset: ${{ matrix.dataset }}
      pipeline: ${{ matrix.pipeline }}
      metrics: der jer sca
      wandb_project: diarization-benchmark
      wandb_run_name: ${{ matrix.pipeline }}-${{ matrix.dataset }}-${{ github.event.date }}
    secrets:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      WANDB_TOKEN: ${{ secrets.WANDB_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}

  diarization-benchmark-sync-data:
    needs: diarization-benchmark
    uses: ./.github/workflows/sync_data.yaml
    with:
      runner: M3-Ultra
      project: diarization-benchmark
      entity: ${{ secrets.WANDB_ENTITY }}
      run_name: ${{ matrix.pipeline }}-${{ matrix.dataset }}-${{ github.event.date }}
      repo_id: openbench-diarization-benchmark # main repo to sync diarization benchmark results.
    secrets:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      WANDB_TOKEN: ${{ secrets.WANDB_TOKEN }}